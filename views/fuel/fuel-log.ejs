<% layout('layouts/main') %>

<!-- ======================================================= -->
<!-- ============= SECCIÓN DE CONTENIDO PRINCIPAL ========== -->
<!-- ======================================================= -->
<div class="row">
  <!-- Columna del Formulario de Registro -->
  <div class="col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3 bg-dark text-white">
        <h6 class="m-0 font-weight-bold"><i class="fas fa-plus-circle me-2"></i>Registrar Nueva Recarga</h6>
      </div>
      <div class="card-body p-4">
        <form id="addFuelForm" action="/fuel/add" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="addTruckSelect" class="form-label">¿Para qué camión?</label>
            <select name="truck" id="addTruckSelect" class="form-select form-select-lg" required>
              <option value="" selected disabled>-- Seleccione un camión --</option>
              <% trucks.forEach(function(t) { %>
                <option value="<%= t._id %>"><%= t.alias || t.placa %></option>
              <% }); %>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label for="addDate" class="form-label">Fecha de Recarga</label><input type="date" name="date" id="addDate" class="form-control" required></div>
            <div class="col-md-6 mb-3"><label for="addMileage" class="form-label">Kilometraje</label><input type="number" name="mileage" id="addMileage" class="form-control" placeholder="Ej: 150000" required></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label for="addQuantity" class="form-label">Cantidad</label><div class="input-group"><input type="number" step="0.01" name="quantity" id="addQuantity" class="form-control" placeholder="Ej: 20.5" required><select name="unit" class="form-select flex-grow-0" style="width: auto;"><option value="Galones" selected>Galones</option><option value="Litros">Litros</option></select></div></div>
            <div class="col-md-6 mb-3"><label for="addPricePerUnit" class="form-label">Precio por Unidad</label><input type="number" step="0.01" name="pricePerUnit" id="addPricePerUnit" class="form-control" placeholder="Ej: 28.50" required></div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3"><label for="addCost" class="form-label">Costo Total</label><div class="input-group"><span class="input-group-text" id="addCurrencySymbol">Q</span><input type="number" step="0.01" name="cost" id="addCost" class="form-control" placeholder="Se calculará..." required></div></div>
            <div class="col-md-6 mb-3"><label for="addCurrency" class="form-label">Moneda</label><select name="currency" id="addCurrency" class="form-select"><option value="GTQ" selected>Quetzales (GTQ)</option><option value="USD">Dólares (USD)</option></select></div>
          </div>
          <div class="mb-4">
            <label for="addImage" class="form-label">Comprobante / Recibo</label><input type="file" name="image" id="addImage" class="form-control" accept="image/*" required>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-danger btn-lg"><i class="fas fa-save me-2"></i>Guardar Registro</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Columna del Historial Reciente -->
  <div class="col-lg-7">
    <h4 class="mb-3">Historial Reciente de Combustible</h4>
    <div class="list-group">
      <% if (fuelRecords.length > 0) { %>
        <% fuelRecords.forEach(function(r) { %>
          <div class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1 fw-bold"><%= r.truck.alias || r.truck.placa %></h5>
              <small class="text-muted"><%= new Date(r.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) %></small>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="mb-1"><span class="fw-bold text-danger"><%= r.quantity.toFixed(2) %> <%= r.unit %></span> por <span class="fw-bold"><%= r.currency === 'GTQ' ? 'Q' : '$' %><%= r.cost.toFixed(2) %></span></p>
                <small class="text-muted"><%= r.mileage.toLocaleString('es-ES') %> km &bull; <%= r.currency === 'GTQ' ? 'Q' : '$' %><%= r.pricePerUnit.toFixed(2) %> por <%= r.unit.slice(0, -2) %></small>
              </div>
<!-- =================== REEMPLAZO (BOTONES EN fuel-log.ejs) =================== -->
              <div class="d-flex gap-1">
                <!-- BOTÓN CORREGIDO Y ESTANDARIZADO CON LA CLASE 'view-receipt-btn' -->
                <button class="btn btn-outline-secondary btn-sm view-receipt-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#imageViewerModal" 
                        data-image-url="<%= r.receiptImage %>" 
                        data-modal-title="Recibo de Combustible - <%= r.truck.alias || r.truck.placa %>">
                    <i class="fas fa-receipt"></i>
                </button>
                
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editFuelModal" data-record='<%- JSON.stringify(r) %>'><i class="fas fa-pencil-alt"></i></button>
                <form action="/fuel/delete/<%= r._id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('¿Seguro que quieres eliminar este registro?');"><button type-="submit" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash"></i></button></form>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="text-center p-5 border rounded"><i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i><h5 class="text-muted">Aún no hay registros de combustible.</h5><p class="text-muted">Utiliza el formulario para añadir la primera recarga.</p></div>
      <% } %>
    </div>
  </div>
</div>

<!-- Modal para EDITAR RECARGA -->
<div class="modal fade" id="editFuelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title">Editar Registro de Combustible</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="editFuelForm" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="_method" value="PUT">
          <div class="mb-3">
            <label for="editTruckSelect" class="form-label">Camión</label>
            <select name="truck" id="editTruckSelect" class="form-select form-select-lg" required>
              <!-- Las opciones se llenarán con JavaScript -->
            </select>
          </div>
          <div class="row"><div class="col-md-6 mb-3"><label for="editDate" class="form-label">Fecha</label><input type="date" name="date" id="editDate" class="form-control" required></div><div class="col-md-6 mb-3"><label for="editMileage" class="form-label">Kilometraje</label><input type="number" name="mileage" id="editMileage" class="form-control" required></div></div>
          <div class="row"><div class="col-md-6 mb-3"><label for="editQuantity" class="form-label">Cantidad</label><div class="input-group"><input type="number" step="0.01" name="quantity" id="editQuantity" class="form-control" required><select name="unit" id="editUnit" class="form-select flex-grow-0" style="width: auto;"><option value="Galones">Galones</option><option value="Litros">Litros</option></select></div></div><div class="col-md-6 mb-3"><label for="editPricePerUnit" class="form-label">Precio/Unidad</label><input type="number" step="0.01" name="pricePerUnit" id="editPricePerUnit" class="form-control" required></div></div>
          <div class="row"><div class="col-md-6 mb-3"><label for="editCost" class="form-label">Costo Total</label><div class="input-group"><span class="input-group-text" id="editCurrencySymbol">Q</span><input type="number" step="0.01" name="cost" id="editCost" class="form-control" required></div></div><div class="col-md-6 mb-3"><label for="editCurrency" class="form-label">Moneda</label><select name="currency" id="editCurrency" class="form-select"><option value="GTQ">Quetzales (GTQ)</option><option value="USD">Dólares (USD)</option></select></div></div>
          <div class="mb-4"><label for="editImage" class="form-label">Nuevo Comprobante (Opcional)</label><input type="file" name="image" id="editImage" class="form-control" accept="image/*"><div class="form-text">Sube algo solo si quieres reemplazar el archivo.</div></div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="editFuelForm" class="btn btn-primary"><i class="fas fa-save me-2"></i>Guardar Cambios</button></div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scripts específicos para esta página -->
<%
  let truckOptionsHTML = '';
  trucks.forEach(function(t) {
    truckOptionsHTML += `<option value="${t._id}">${t.alias || t.placa}</option>`;
  });
%>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const truckOptionsHTML = `<%- truckOptionsHTML %>`;

    // --- LÓGICA DE CÁLCULO AUTOMÁTICO PARA EL FORMULARIO DE AÑADIR ---
    const addQuantityInput = document.getElementById('addQuantity');
    const addPriceInput = document.getElementById('addPricePerUnit');
    const addCostInput = document.getElementById('addCost');
    const addCurrencySelect = document.getElementById('addCurrency');
    const addCurrencySymbol = document.getElementById('addCurrencySymbol');

    function calculateTotal() {
        if (!addQuantityInput || !addPriceInput || !addCostInput) return;
        const quantity = parseFloat(addQuantityInput.value) || 0;
        const price = parseFloat(addPriceInput.value) || 0;
        if (quantity > 0 && price > 0) { addCostInput.value = (quantity * price).toFixed(2); }
    }
    function updateSymbol() {
        if (!addCurrencySelect || !addCurrencySymbol) return;
        addCurrencySymbol.textContent = addCurrencySelect.value === 'GTQ' ? 'Q' : '$';
    }
    if(addQuantityInput) addQuantityInput.addEventListener('input', calculateTotal);
    if(addPriceInput) addPriceInput.addEventListener('input', calculateTotal);
    if(addCurrencySelect) addCurrencySelect.addEventListener('change', updateSymbol);
    updateSymbol();

    // --- LÓGICA PARA POBLAR EL MODAL DE EDICIÓN ---
    const editFuelModalEl = document.getElementById('editFuelModal');
    if (editFuelModalEl) {
        const editQuantityInput = document.getElementById('editQuantity');
        const editPriceInput = document.getElementById('editPricePerUnit');
        const editCostInput = document.getElementById('editCost');
        const editCurrencySelect = document.getElementById('editCurrency');
        const editCurrencySymbol = document.getElementById('editCurrencySymbol');
        const editTruckSelect = document.getElementById('editTruckSelect');

        function calculateEditTotal() {
            if (!editQuantityInput || !editPriceInput || !editCostInput) return;
            const quantity = parseFloat(editQuantityInput.value) || 0;
            const price = parseFloat(editPriceInput.value) || 0;
            if (quantity > 0 && price > 0) { editCostInput.value = (quantity * price).toFixed(2); }
        }
        function updateEditSymbol() {
            if (!editCurrencySelect || !editCurrencySymbol) return;
            editCurrencySymbol.textContent = editCurrencySelect.value === 'GTQ' ? 'Q' : '$';
        }

        if(editQuantityInput) editQuantityInput.addEventListener('input', calculateEditTotal);
        if(editPriceInput) editPriceInput.addEventListener('input', calculateEditTotal);
        if(editCurrencySelect) editCurrencySelect.addEventListener('change', updateEditSymbol);

        editFuelModalEl.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const record = JSON.parse(button.getAttribute('data-record'));
            const form = editFuelModalEl.querySelector('#editFuelForm');
            
            form.action = `/fuel/update/${record._id}?_method=PUT`;
            
            // Llenar y seleccionar el camión
            editTruckSelect.innerHTML = truckOptionsHTML;
            form.querySelector('#editTruckSelect').value = record.truck._id;
            
            form.querySelector('#editDate').value = new Date(record.date).toISOString().split('T')[0];
            form.querySelector('#editMileage').value = record.mileage;
            form.querySelector('#editQuantity').value = record.quantity;
            form.querySelector('#editUnit').value = record.unit;
            form.querySelector('#editPricePerUnit').value = record.pricePerUnit;
            form.querySelector('#editCost').value = record.cost;
            form.querySelector('#editCurrency').value = record.currency;
            
            updateEditSymbol();
        });
    }
});
</script>